tinymce.PluginManager.add("media",function(e,t){function r(t){var n,r,i=e.dom,s=e.selection.getNode();var o,u,a;var f="RESPONSIVE FileManager";if(typeof tinymce.settings.filemanager_title!=="undefined"&&tinymce.settings.filemanager_title){f=tinymce.settings.filemanager_title}n=e.windowManager.open({title:f,data:r,classes:"filemanager",file:tinyMCE.baseURL+"/plugins/filemanager/dialog.php?type="+t+"&editor="+e.id+"&lang="+tinymce.settings.language,filetype:"file",width:900,height:600,inline:1})}function i(e){if(e.indexOf(".mp3")!=-1){return"audio/mpeg"}if(e.indexOf(".wav")!=-1){return"audio/wav"}if(e.indexOf(".mp4")!=-1){return"video/mp4"}if(e.indexOf(".webm")!=-1){return"video/webm"}if(e.indexOf(".ogg")!=-1){return"video/ogg"}if(e.indexOf(".swf")!=-1){return"application/x-shockwave-flash"}return""}function s(){function l(e){var r,s,o,u;r=t.find("#width")[0];s=t.find("#height")[0];o=r.value();u=s.value();if(t.find("#constrain")[0].checked()&&n&&i&&o&&u){if(e.control==r){u=Math.round(o/n*u);s.value(u)}else{o=Math.round(u/i*o);r.value(o)}}n=o;i=u}var t,n,i,s;s=f(e.selection.getNode());n=s.width;i=s.height;var c=e.id.replace("[","").replace("]","");t=e.windowManager.open({title:"Insert/edit video",data:s,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(a(this.next().find("#embed").value()))},items:[{type:"container",layout:"flex",classes:"combobox has-open",label:"Source",direction:"row",items:[{name:"source1",type:"textbox",filetype:"media",size:35,autofocus:true,classes:"video3_"+c},{name:"upl_video",type:"button",classes:"btn open",icon:"browse",onclick:function(){r(3)},tooltip:"Select video"}]},{type:"container",layout:"flex",classes:"combobox has-open",label:"Alternative source",direction:"row",items:[{name:"source2",type:"textbox",filetype:"media",size:35,classes:"video4_"+c},{name:"upl_video1",type:"button",classes:"btn open",icon:"browse",onclick:function(){r(4)},tooltip:"Select video"}]},{type:"container",layout:"flex",classes:"combobox has-open",label:"Poster",direction:"row",items:[{name:"poster",type:"textbox",filetype:"image",size:35,classes:"video5_"+c},{name:"upl_video2",type:"button",classes:"btn open",icon:"browse",onclick:function(){r(5)},tooltip:"Select video"}]},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:l},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:l},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:o(),multiline:true,label:"Source"}]}],onSubmit:function(){e.insertContent(u(this.toJSON()))}})}function o(){var t=e.selection.getNode();if(t.getAttribute("data-mce-object")){return e.selection.getContent()}}function u(r){var s="";if(!r.source1){tinymce.extend(r,a(r.embed));if(!r.source1){return""}}r.source1=e.convertURL(r.source1,"source");r.source2=e.convertURL(r.source2,"source");r.source1mime=i(r.source1);r.source2mime=i(r.source2);r.poster=e.convertURL(r.poster,"poster");r.flashPlayerUrl=e.convertURL(t+"/moxieplayer.swf","movie");if(r.embed){s=l(r.embed,r,true)}else{tinymce.each(n,function(e){var t,n,i;if(t=e.regex.exec(r.source1)){i=e.url;for(n=0;t[n];n++){i=i.replace("$"+n,function(){return t[n]})}r.source1=i;r.type=e.type;r.width=e.w;r.height=e.h}});r.width=r.width||300;r.height=r.height||150;tinymce.each(r,function(t,n){r[n]=e.dom.encode(t)});if(r.type=="iframe"){s+='<iframe src="'+r.source1+'" width="'+r.width+'" height="'+r.height+'"></iframe>'}else if(r.source1mime=="application/x-shockwave-flash"){s+='<object data="'+r.source1+'" width="'+r.width+'" height="'+r.height+'" type="application/x-shockwave-flash">';if(r.poster){s+='<img src="'+r.poster+'" width="'+r.width+'" height="'+r.height+'" />'}s+="</object>"}else if(r.source1mime.indexOf("audio")!=-1){if(e.settings.audio_template_callback){s=e.settings.audio_template_callback(r)}else{s+='<audio controls="controls" src="'+r.source1+'">'+(r.source2?'\n<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"</audio>"}}else{if(e.settings.video_template_callback){s=e.settings.video_template_callback(r)}else{s='<video width="'+r.width+'" height="'+r.height+'"'+(r.poster?' poster="'+r.poster+'"':"")+' controls="controls">\n'+'<source src="'+r.source1+'"'+(r.source1mime?' type="'+r.source1mime+'"':"")+" />\n"+(r.source2?'<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"</video>"}}}return s}function a(e){var t={};(new tinymce.html.SaxParser({validate:false,special:"script,noscript",start:function(e,n){if(!t.source1&&e=="param"){t.source1=n.map.movie}if(e=="iframe"||e=="object"||e=="embed"||e=="video"||e=="audio"){t=tinymce.extend(n.map,t)}if(e=="source"){if(!t.source1){t.source1=n.map.src}else if(!t.source2){t.source2=n.map.src}}if(e=="img"&&!t.poster){t.poster=n.map.src}}})).parse(e);t.source1=t.source1||t.src||t.data;t.source2=t.source2||"";t.poster=t.poster||"";return t}function f(t){if(t.getAttribute("data-mce-object")){return a(e.serializer.serialize(t,{selection:true}))}return{}}function l(e,t,n){function o(e,t){var n,r,i,s;for(n in t){i=""+t[n];if(e.map[n]){r=e.length;while(r--){s=e[r];if(s.name==n){if(i){e.map[n]=i;s.value=i}else{delete e.map[n];e.splice(r,1)}}}}else if(i){e.push({name:n,value:i});e.map[n]=i}}}var r=new tinymce.html.Writer;var i=0,s;(new tinymce.html.SaxParser({validate:false,special:"script,noscript",comment:function(e){r.comment(e)},cdata:function(e){r.cdata(e)},text:function(e,t){r.text(e,t)},start:function(e,u,a){switch(e){case"video":case"object":case"img":case"iframe":o(u,{width:t.width,height:t.height});break}if(n){switch(e){case"video":o(u,{poster:t.poster,src:""});if(t.source2){o(u,{src:""})}break;case"iframe":o(u,{src:t.source1});break;case"source":i++;if(i<=2){o(u,{src:t["source"+i],type:t["source"+i+"mime"]});if(!t["source"+i]){return}}break;case"img":if(!t.poster){return}s=true;break}}r.start(e,u,a)},end:function(e){if(e=="video"&&n){for(var u=1;u<=2;u++){if(t["source"+u]){var a=[];a.map={};if(i<u){o(a,{src:t["source"+u],type:t["source"+u+"mime"]});r.start("source",a,true)}}}}if(t.poster&&e=="object"&&n&&!s){var f=[];f.map={};o(f,{src:t.poster,width:t.width,height:t.height});r.start("img",f,true)}r.end(e)}},new tinymce.html.Schema({}))).parse(e);return r.getContent()}var n=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];e.on("ResolveName",function(e){var t;if(e.target.nodeType==1&&(t=e.target.getAttribute("data-mce-object"))){e.name=t}});e.on("preInit",function(){var t=e.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});e.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var n=e.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){n[e]={}});e.parser.addNodeFilter("iframe,video,audio,object,embed",function(t,n){var r=t.length,i,s,o,u,a,f,l;while(r--){s=t[r];o=new tinymce.html.Node("img",1);o.shortEnded=true;f=s.attributes;i=f.length;while(i--){u=f[i].name;a=f[i].value;if(u!=="width"&&u!=="height"&&u!=="style"){if(u=="data"||u=="src"){a=e.convertURL(a,u)}o.attr("data-mce-p-"+u,a)}}l=s.firstChild&&s.firstChild.value;if(l){o.attr("data-mce-html",escape(l));o.firstChild=null}o.attr({width:s.attr("width")||"300",height:s.attr("height")||(n=="audio"?"30":"150"),style:s.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":n,"class":"mce-object mce-object-"+n});s.replace(o)}});e.serializer.addAttributeFilter("data-mce-object",function(e,t){var n=e.length,r,i,s,o,u,a;while(n--){r=e[n];i=new tinymce.html.Node(r.attr(t),1);if(r.attr(t)!="audio"){i.attr({width:r.attr("width"),height:r.attr("height")})}i.attr({style:r.attr("style")});o=r.attributes;s=o.length;while(s--){var f=o[s].name;if(f.indexOf("data-mce-p-")===0){i.attr(f.substr(11),o[s].value)}}u=r.attr("data-mce-html");if(u){a=new tinymce.html.Node("#text",3);a.raw=true;a.value=unescape(u);i.append(a)}r.replace(i)}})});e.on("ObjectSelected",function(e){if(e.target.getAttribute("data-mce-object")=="audio"){e.preventDefault()}});e.on("objectResized",function(e){var t=e.target,n;if(t.getAttribute("data-mce-object")){n=t.getAttribute("data-mce-html");if(n){n=unescape(n);t.setAttribute("data-mce-html",escape(l(n,{width:e.width,height:e.height})))}}});e.addButton("media",{tooltip:"Insert/edit video",onclick:s,stateSelector:"img[data-mce-object=video]"});e.addMenuItem("media",{icon:"media",text:"Insert video",onclick:s,context:"insert",prependToContext:true})})